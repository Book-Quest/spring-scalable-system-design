# ëŒ“ê¸€ ìµœëŒ€ 2 depth ì‚­ì œ (DELETE)

## 1) Soft Delete VS Hard Delete

### (1) Soft Delete

ë°ì´í„°ë² ì´ìŠ¤ì—ì„œ ë°ì´í„°ë¥¼ ì‚­ì œí•˜ì§€ ì•Šê³ , ì‚¬ìš©ì ì…ì¥ì—ì„œëŠ” ë°ì´í„°ì— ì ‘ê·¼í•  ìˆ˜ ì—†ê²Œ í•˜ëŠ” ë°©ì‹

- í…Œì´ë¸”ì— `deleted` ì»¬ëŸ¼ì„ ë§Œë“¤ì–´ booleanê°’ìœ¼ë¡œ ë°ì´í„° ì‚¬ìš© ì—¬ë¶€ë¥¼ ê²°ì •í•˜ëŠ” ë°©ì‹
    - `deleted`ê°€ falseì´ë©´ ì¡°íšŒ ê°€ëŠ¥, `deleted`ê°€ trueì´ë©´ ì¡°íšŒ ë¶ˆê°€ëŠ¥
- ë°ì´í„°ê°€ ì‚­ì œëœ ê²ƒì²˜ëŸ¼ í•´ë‹¹ ë°ì´í„°ì— ì ‘ê·¼ ë¶ˆê°€ëŠ¥í•˜ì§€ë§Œ, DBì—ëŠ” ë°ì´í„°ê°€ ì—¬ì „íˆ ì¡´ì¬

#### **[ì¥ì ]**

- **ë°ì´í„° ë³µêµ¬ ì‰¬ì›€** : ì‹¤ìˆ˜ë¡œ ì‚­ì œí•´ë„ UPDATEë¥¼ ì‚¬ìš©í•˜ì—¬ ë³µêµ¬í•  ìˆ˜ ìˆìŒ
- **ì°¸ì¡° ë¬´ê²°ì„± ìœ ì§€** : ë‹¤ë¥¸ í…Œì´ë¸”ì—ì„œ ì°¸ì¡° ì¤‘ì¸ ë°ì´í„°ë¥¼ ìœ ì§€í•˜ë©´ì„œ ì‚­ì œ ê°€ëŠ¥
- **ì‚­ì œ ë¡œê·¸ ê´€ë¦¬ ìš©ì´** : ì–¸ì œ, ëˆ„ê°€ ì‚­ì œí–ˆëŠ”ì§€ ì‚­ì œ ì´ë ¥ ê´€ë¦¬ ê°€ëŠ¥

#### **[í•œê³„]**

- ì‹¤ì œë¡œ ì‚­ì œí•˜ì§€ ì•Šìœ¼ë¯€ë¡œ ë°ì´í„°ë² ì´ìŠ¤ê°€ ì»¤ì§ˆ ìˆ˜ ìˆìŒ
- `deleted = false` ì¡°ê±´ì„ ë„£ì§€ ì•Šìœ¼ë©´ ì‚­ì œëœ ë°ì´í„°ë„ ì¡°íšŒë  ìˆ˜ ìˆìŒ
- **ì„±ëŠ¥ ì €í•˜ ê°€ëŠ¥ì„±** : íŠ¹íˆ ëŒ€ëŸ‰ì˜ ë°ì´í„°ê°€ ë…¼ë¦¬ì ìœ¼ë¡œ ì‚­ì œëœ ê²½ìš°, í•´ë‹¹ ë°ì´í„°ë¥¼ ë§¤ë²ˆ ê±´ë„ˆë›°ì–´ì•¼ í•˜ë¯€ë¡œ ì„±ëŠ¥ì— ì˜í–¥ì„ ì¤„ ìˆ˜ ìˆìŒ

**Hibernate ì˜ˆì‹œ:**

```java
@Where(clause = "deleted = false")
@Entity
@Table(name = "comment")
public class Comment {
    // ...
}
```

- ì´ ë°©ì‹ìœ¼ë¡œ ì¿¼ë¦¬ë§ˆë‹¤ `deleted=false` ì¡°ê±´ì„ ìë™ìœ¼ë¡œ ì¶”ê°€í•´ì£¼ì–´ ì‹¤ìˆ˜ë¡œ ì‚­ì œëœ ë°ì´í„°ë¥¼ ì¡°íšŒí•˜ëŠ” ì¼ì„ ë°©ì§€í•  ìˆ˜ ìˆìŒ
- @Where ì–´ë…¸í…Œì´ì…˜ì— ëª…ì‹œí–ˆë˜ ì¡°ê±´ì´ ì¿¼ë¦¬ì— ë°˜ì˜ë˜ëŠ” ê²½ìš°
    - âœ… ì—”í‹°í‹° ì „ë¶€ë¥¼ ì¡°íšŒ (`select * from comment;` )
    - âŒ íŠ¹ì • í•„ë“œë§Œ ì¡°íšŒ (`select comment_id, content from comment;` )

### (2) Hard Delete

ë°ì´í„°ë² ì´ìŠ¤ì—ì„œ ë°ì´í„°ë¥¼ ì§ì ‘ ì‚­ì œí•˜ëŠ” ë°©ì‹

- DELETE ì¿¼ë¦¬ë¥¼ ë‚ ë¦¬ëŠ” ë°©ì‹
- ë” ì´ìƒ ì‚¬ìš©í•˜ì§€ ì•ŠëŠ” ë°ì´í„°ë¥¼ DBì— ì €ì¥í•˜ëŠ” ê²ƒì€ ì €ì¥ ê³µê°„ ë‚­ë¹„ì¼ ìˆ˜ ìˆìŒ.

#### **[ì¥ì ]**

- **ê³µê°„ ì ˆì•½** : ë°ì´í„°ê°€ ë°ì´í„°ë² ì´ìŠ¤ì—ì„œ ì™„ì „íˆ ì œê±°ë˜ì–´ ì €ì¥ ê³µê°„ì„ ì ˆì•½í•  ìˆ˜ ìˆìŒ
- `deleted=false` ì¡°ê±´ì„ ì¶”ê°€í•  í•„ìš” ì—†ì´ ë°ì´í„° ì¡°íšŒê°€ ê°€ëŠ¥

#### **[í•œê³„]**

- **ë³µêµ¬ ë¶ˆê°€ëŠ¥**: ì‚­ì œëœ ë°ì´í„°ë¥¼ ë˜ëŒë¦´ ìˆ˜ ì—†ìœ¼ë¯€ë¡œ ì‹¤ìˆ˜ë¡œ ì‚­ì œëœ ë°ì´í„°ë¥¼ ë³µêµ¬í•  ìˆ˜ ì—†ìŒ.
- **ì°¸ì¡° ë¬´ê²°ì„± ë¬¸ì œ**: ë‹¤ë¥¸ í…Œì´ë¸”ì—ì„œ ì°¸ì¡° ì¤‘ì´ë©´ ì‚­ì œê°€ ì–´ë µê±°ë‚˜, ì‚­ì œí•  ë•Œ ì¶”ê°€ì ì¸ ì²˜ë¦¬(Foreign Key CASCADE ì„¤ì • ë“±)ê°€ í•„ìš”í•¨.

### (3) Soft Delete VS Hard Delete

|  | Soft Delete | Hard Delete |
| --- | --- | --- |
| **ì„¤ì • ìš©ì´ì„±**  | âœ… ë‹¨ìˆœíˆ ì—´ì„ UPDATEí•˜ëŠ”ë°©ì‹ìœ¼ë¡œ êµ¬í˜„ì´ ë” ì‰¬ì›€  | ğŸŸ¥ ì‚­ì œí•  ë°ì´í„°ë¥¼ **Audit table**ë¡œ ë³µì‚¬í•˜ëŠ” ì‘ì—…ì´ í¬í•¨ë˜ì–´ ì„¤ì •ì´ ì–´ë ¤ì›€ |
| **ë””ë²„ê¹…** | âœ… `deleted`ê³¼ **Audit table**ë¥¼ í†µí•´ ë””ë²„ê¹… ê°€ëŠ¥ | âœ… **Audit table**ë¥¼ í†µí•´ ë””ë²„ê¹… ê°€ëŠ¥ |
| **ë°ì´í„° ë³µì›** | âœ… `deleted=false` ë¡œ ì‚­ì œëœ ë°ì´í„°ë¥¼ ë³µì›í•˜ê¸° ì‰¬ì›€ | ğŸŸ¥  |
| **active data ì¿¼ë¦¬** | ğŸŸ¥ where ì¡°ê±´ì— `deleted=false` ì¡°ê±´ì„ ì¶”ê°€í•˜ëŠ” ê²ƒì„ ìŠì—ˆì„ ë•Œ ë¬¸ì œê°€ ë°œìƒí•  ê°€ëŠ¥ì„± ìˆìŒ (`@where` ìœ¼ë¡œ í•´ê²° ê°€ëŠ¥) | âœ… ì‚­ì œëœ ë°ì´í„°ë¥¼ ì¡°íšŒí•  ê°€ëŠ¥ì„± ì—†ìŒ |
| **ë·° ë‹¨ìˆœì„±** | ğŸŸ¥ active dataì™€ ì‚­ì œëœ ë°ì´í„°ê°€ í•œ í…Œì´ë¸”ì— ì¡´ì¬ | âœ… ì‚­ì œëœ ë°ì´í„°ëŠ” audit tableì—ë§Œ ìˆê³  active dataëŠ” ë‚˜ë¨¸ì§€ í…Œì´ë¸”ì— ì¡´ì¬ (ë¶„ë¦¬) |
| **ì‘ì—… ì„±ëŠ¥** | âœ… UPDATEëŠ” DELETEë³´ë‹¤ ë¹ ë¦„(microsecond) | ğŸŸ¥  |
| **ì• í”Œë¦¬ì¼€ì´ì…˜ ì†ë„** | ğŸŸ¥ ëª¨ë“  SELECT ì¿¼ë¦¬ì— `deleted=false` ê°€ ì¶”ê°€ë˜ì–´ ë” ëŠë¦¼ | âœ… ì¡°ê±´ì´ ë” ì ìœ¼ë¯€ë¡œ ì¿¼ë¦¬ ì†ë„ê°€ ë” ë¹ ë¦„ |
| **ì• í”Œë¦¬ì¼€ì´ì…˜ í¬ê¸°** | ğŸŸ¥ ì‚­ì œëœ ë°ì´í„°ì™€ active ë°ì´í„°ê°€ í•œ í…Œì´ë¸”ì— ì¡´ì¬í•˜ì—¬ í…Œì´ë¸” í¬ê¸°ê°€ ì»¤ì§ | âœ… active dataë§Œ í…Œì´ë¸”ì— ì¡´ì¬í•˜ì—¬ ê³µê°„ ì ˆì•½ |
| **DB UNIQUE Index** | ğŸŸ¥ **UNIQUE index ì‚¬ìš© ë¶ˆê°€ëŠ¥** ex) unique index : (ì»¬ëŸ¼a, ì»¬ëŸ¼b, deleted) | âœ… ë°ì´í„°ê°€ ì•„ì˜ˆ ì‚­ì œë˜ë¯€ë¡œ ìƒˆë¡œìš´ ë°ì´í„°ë¥¼ ì‚½ì…í•  ë•Œ UNIQUE indexê°€ ì¶©ëŒí•˜ì§€ ì•ŠìŒ |
| **DB CASCADING** | ğŸŸ¥ ON DELETE CASCADE ì‚¬ìš© ë¶ˆê°€ | âœ… ON DELETE CASCADE ì‚¬ìš© |

#### **[Audit table]**

ê´€ë¦¬ ê¶Œí•œì´ ìˆëŠ” ê²½ìš°ì—ë§Œ ì ‘ê·¼í•  ìˆ˜ ìˆëŠ” í…Œì´ë¸”ë¡œ, íŠ¹ì • í…Œì´ë¸”ì—ì„œ ìˆ˜í–‰ë˜ëŠ” ì‘ì—…ì„ ì¶”ì í•˜ëŠ” ê¸°ëŠ¥ì„ í•¨

- ì¼ë°˜ì ìœ¼ë¡œ ì‹œê°„ì •ë³´(ìƒì„±ì¼ì, ìˆ˜ì •ì¼ì, ì‚­ì œì¼ì)ì™€ ì‚¬ìš©ì ì •ë³´(ìƒì„±ì, ìˆ˜ì •ì)ë¥¼ ì €ì¥
- audit tableì˜ ë ˆì½”ë“œëŠ” ì—…ë°ì´íŠ¸í•˜ê±°ë‚˜ ì‚­ì œí•  ìˆ˜ ì—†ìœ¼ë©°, ì‚½ì…ë§Œ ê°€ëŠ¥.
    - ë ˆì½”ë“œë¥¼ ì—…ë°ì´íŠ¸ ë° ì‚­ì œí•˜ë ¤ë©´ ì¶”ê°€ ìŠ¹ì¸ê³¼ ê°™ì€ í”„ë¡œì„¸ìŠ¤ê°€ ê°€ëŠ¥

ì˜ˆì‹œ : 

```sql
CREATE TABLE comment_audit (
    audit_id BIGINT PRIMARY KEY AUTO_INCREMENT,  -- ê°ì‚¬ ë¡œê·¸ì˜ ê³ ìœ  ì‹ë³„ì
    table_name VARCHAR(255) NOT NULL,      --  ë³€ê²½ì´ ë°œìƒí•œ í…Œì´ë¸”ëª…
    record_id INT NOT NULL,                -- ë³€ê²½ëœ ë ˆì½”ë“œì˜ ê³ ìœ  ì‹ë³„ì
    action_type VARCHAR(10),               -- ë³€ê²½ ìœ í˜• (INSERT, UPDATE, DELETE)
    old_values TEXT,                       -- ë³€ê²½ ì „ ë ˆì½”ë“œ ê°’ (JSON ë˜ëŠ” XML í˜•ì‹)
    new_values TEXT,                       -- ë³€ê²½ í›„ ë ˆì½”ë“œ ê°’ (JSON ë˜í” XML í˜•ì‹)
    created_by VARCHAR(255),               -- ë³€ê²½ì„ ìˆ˜í–‰í•œ ì‚¬ìš©ì
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,  -- ë³€ê²½ëœ ì‹œê°„
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP  -- ë³€ê²½ì´ë ¥ ìˆ˜ì • ì‹œê°
);

```

#### **[Unique Index ë¬¸ì œ]**

- **Unique Index :** ì¤‘ë³µ ë°ì´í„°ë¥¼ ë§‰ê¸° ìœ„í•´ íŠ¹ì • ì»¬ëŸ¼ ì¡°í•©ì— ëŒ€í•´ ìœ ì¼í•œ ê°’ë§Œ ì €ì¥í•˜ë„ë¡ ê°•ì œí•˜ëŠ” ê¸°ëŠ¥
- ì˜ˆì‹œ ) Unique Indexê°€ `(ì»¬ëŸ¼A, ì»¬ëŸ¼B, deleted)`
    1. **soft delete** : `(A1, B1, false)` â†’ `(A1, B1, true)`
    2. (A1,B1)ê°€ í…Œì´ë¸”ì— ì¶”ê°€ë¨ : `(A1,B1,false)`
    3. `(A1,B1,false)`ëŠ” soft delete ë  ìˆ˜ ì—†ìŒ. 

### (4) Soft Deleteì™€ Hard DeleteëŠ” ì–¸ì œ ì‚¬ìš©í• ê¹Œ?

**[Soft Delete]**

- ë°ì´í„° ë³µêµ¬ì˜ í•„ìš”ì„±ì´ ë†’ì„ ë•Œ
- ì°¸ì¡° ë¬´ê²°ì„± ë¬¸ì œë¥¼ í”¼í•˜ê³  ì‹¶ì„ ë•Œ
- ì‚­ì œë˜ë”ë¼ë„ ë°ì´í„°ê°€ ìœ ì§€ë˜ì–´ì•¼ í•˜ëŠ” ê²½ìš°

**[Hard Delete]**

- ë°ì´í„°ë² ì´ìŠ¤ì˜ ì €ì¥ ê³µê°„ì„ íš¨ìœ¨ì ìœ¼ë¡œ í™œìš©í•˜ê³  ì‹¶ì„ ë•Œ
- ì„±ëŠ¥ ìµœì í™”ê°€ í•„ìš”í•œ ê²½ìš°
- íŠ¹ì • ìƒí™©ì—ì„œë§Œ í•„ìš”í•˜ê³  ë‚¨ê²¨ë„ ë˜ì§€ ì•ŠëŠ” ë°ì´í„°

## 2) **2-depth ëŒ“ê¸€ì˜ ì¬ê·€ì  ì‚­ì œ ë¡œì§**

### DELETE ì¼€ì´ìŠ¤

- ì‚­ì œí•  ëŒ“ê¸€ì´ ìì‹ ìˆìœ¼ë©´, ì‚­ì œ í‘œì‹œë§Œ í•œë‹¤
- í•˜ìœ„ ëŒ“ê¸€ì´ ì‚­ì œë˜ê³ , ì‚­ì œë˜ì§€ ì•Šì€ ë¶€ëª¨ë©´, í•˜ìœ„ ëŒ“ê¸€ë§Œ ì‚­ì œí•œë‹¤.
- í•˜ìœ„ ëŒ“ê¸€ì´ ì‚­ì œë˜ê³ , ì‚­ì œëœ ë¶€ëª¨ë©´, ì¬ê·€ì ìœ¼ë¡œ ëª¨ë‘ ì‚­ì œí•œë‹¤.

### ëŒ“ê¸€ ì‚­ì œ ë¡œì§

```java
@Transactional
public void delete(Long commentId) {
    commentRepository.findById(commentId)           // ëŒ“ê¸€ idë¡œ ëŒ“ê¸€ ì°¾ê¸°
            .filter(not(Comment::getDeleted))       // ì•„ì§ ì‚­ì œë˜ì§€ ì•Šì€ ëŒ“ê¸€ì¸ì§€ í™•ì¸
            .ifPresent(comment -> {                 // ëŒ“ê¸€ì´ ìˆìœ¼ë©´ ì‚­ì œ
                if (hasChildren(comment)) {         // í•˜ìœ„ ëŒ“ê¸€ì´ ìˆë‹¤ë©´ ì‚­ì œ í‘œì‹œë§Œ
                    comment.delete();
                } else {                            // í•˜ìœ„ ëŒ“ê¸€ì´ ì—†ë‹¤ë©´ ì‚­ì œ
                    delete(comment);
                }
            });
}
```

1. comment_idë¡œ ëŒ“ê¸€ ì¡°íšŒ
2. ë§Œì•½ ì‚­ì œë˜ì§€ ì•Šì€ ìƒíƒœë¼ë©´, ìì‹ ëŒ“ê¸€ì´ ìˆëŠ”ì§€ í™•ì¸í•œë‹¤.
    
    ```java
    private boolean hasChildren(Comment comment) {
        // commentIdë¥¼ parentCommentIdë¡œ ê°€ì§€ëŠ” commentë“¤ì˜ ìˆ˜ë¥¼ ì„¸ê¸°
        return commentRepository.countBy(comment.getArticleId(), comment.getCommentId(), 2L) == 2;
    }
    ```
    
    ```sql
    select count(*) from (
       select comment_id from comment
       where article_id = :articleId and parent_comment_id = :parentCommentId
       limit :limit
    )
    ```
    
    - commentIdë¥¼ parentCommentIdë¡œ ê°€ì§€ëŠ” comment(ìì‹)ë“¤ì˜ ìˆ˜ë¥¼ ì„¸ê¸°
        - root ëŒ“ê¸€ì¸ ê²½ìš°, ìì‹ì´ 1ê°œ ì´ìƒì¸ì§€ í™•ì¸í•˜ê¸° ìœ„í•´ limit 2ë¡œ ì§€ì •
3. ëŒ“ê¸€ ì‚­ì œ
    
    ```java
    private void delete(Comment comment) {
        // ì‚­ì œ
        commentRepository.delete(comment);
        // í•˜ìœ„ ëŒ“ê¸€ì´ ì‚­ì œê°€ ëìœ¼ë©´ deleted=true, í•˜ìœ„ ëŒ“ê¸€ì´ ì—†ëŠ” ìƒìœ„ ëŒ“ê¸€ì„ ì¬ê·€ì ìœ¼ë¡œ ì‚­ì œ
        if(!comment.isRoot()) {
            commentRepository.findById(comment.getParentCommentId())        // ìƒìœ„ ëŒ“ê¸€
                    .filter(Comment::getDeleted)                            // ìƒìœ„ëŒ“ê¸€ì´ ì‚­ì œê°€ ë˜ì–´ìˆëŠ”ì§€ í™•ì¸
                    .filter(not(this::hasChildren))                         // ìƒìœ„ëŒ“ê¸€ì´ ë˜ ë‹¤ë¥¸ ìì‹ì„ ê°€ì§€ê³  ìˆì§€ ì•Šì€ì§€ í™•ì¸
                    .ifPresent(his::delete);                               // ì¬ê·€ì ìœ¼ë¡œ ìƒìœ„ ëŒ“ê¸€ ì‚­ì œ
        }
    }
    ```
    
    - ìì‹ ëŒ“ê¸€ì´ ìˆë‹¤ë©´ `deleted=true`ë¡œ Soft Delete ì²˜ë¦¬
    - ìì‹ ëŒ“ê¸€ì´ ì—†ë‹¤ë©´ DBì—ì„œ ì‹¤ì œ ì‚­ì œ (Hard Delete)
4. ë§Œì•½ ë¶€ëª¨ ëŒ“ê¸€ì´ ì‚­ì œëœ ìƒíƒœì´ê³ , ë¶€ëª¨ ëŒ“ê¸€ì´ ë‹¤ë¥¸ ìì‹ ëŒ“ê¸€ì„ ê°€ì§€ê³  ìˆì§€ ì•Šë‹¤ë©´, ë¶€ëª¨ë„ ì‚­ì œí•œë‹¤.

---

**ì°¸ê³ ìë£Œ**

https://velog.io/@heypop/2023.10.22-Soft-Delete-Hard-Delete

https://dgjinsu.tistory.com/77

https://abstraction.blog/2015/06/28/soft-vs-hard-delete#recommendation

[https://velog.io/@yhlee9753/soft-delete-ì™€-hard-delete-ë¹„êµ](https://velog.io/@yhlee9753/soft-delete-%EC%99%80-hard-delete-%EB%B9%84%EA%B5%90)
