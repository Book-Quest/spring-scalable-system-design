# 데이터베이스의 규모 확장

## 1. 수직적 확장

데이터베이스 서버의 CPU, RAM, 디스크와 같은 자원을 증설하는 방법이지만, 아래와 같은 단점이 존재한다.

1. 서버 하드웨어를 무한 증설할 수 없으므로 한계가 존재
2. 하나의 데이터베이스를 수직 확장하면 SPOF로 인한 위험성이 큼
3. 고성능 서버로 갈수록 가격이 올라가므로 고비용

## 2. 수평적 확장

### 샤딩(Sharding)이란?

샤딩은 대규모 데이터베이스를 여러 개의 작은 데이터베이스(샤드)로 분산하여 저장하는 기술

- **샤드 (Shard)**: 샤딩된 각각의 데이터 단위
- **샤드 키 (Shard Key)**: 데이터를 분배할 기준이 되는 속성

### 샤딩의 종류

**1. 수직 샤딩 (Vertical Sharding)**

데이터를 수직으로 분할하는 방식(컬럼 단위)

- **장점:**
    - 각 샤드가 적은 수의 컬럼을 저장하므로, 성능 및 공간 이점이 생긴다.
    - 자주 사용되는 컬럼들을 분리하여 성능을 최적화할 수 있다.
- **단점:**
    - 데이터의 분리로 인해 조인 또는 트랜잭션 관리가 복잡해질 수 있다.
    - 수직으로 분할되므로 수평적 확장에 **제한**이 있다.

**2. 수평 샤딩 (Horizontal Sharding)**

데이터를 수평으로 분할하는 방식 (행 단위)

- **장점:**
    - 각 샤드에 데이터가 분산 저장되므로 성능 및 공간 이점이 생긴다.
    - 수평으로 분할되므로 수평적 확장에 **용이**하다.
- 단점:
    - 데이터의 분리로 인해 조인 또는 트랜잭션 관리가 복잡해질 수 있다.
    - 샤드 간 데이터 불균형이 발생할 수 있다.

### 샤딩 전략

샤딩 전략에서 가장 중요하게 고려할 것은 **샤드 키**를 어떻게 정하느냐이다. 샤드 키를 정할때는 데이터가 고르게 분할될 수 있도록 하는게 중요하다. 샤드가 고르게 분할되지 않았을 때는 아래와 같은 문제가 발생한다.

- **유명인사(celebrity) 문제:**
    - 특정 샤드에 질의가 집중되어 서버에 과부하가 걸리는 문제로, 유명인사 각각에 샤드 하나씩을 할당해야 할 수도 있고, 더 잘게 샤드를 쪼개야할수도 있다.
- **조인과 비정규화(join and de-normalization) 문제:**
    - 하나의 데이터베이스를 여러 서버로 쪼개면, 여러 샤드에 걸친 데이터를 조인하기 힘들다. 이를 해결하는 방법 중 하나는 데이터베이스를 비정규화 하여 조인 없이 하나의 테이블에서 질의가 수행될 수 있도록 하는 것이다.

### 구체적인 샤딩 방법

**1. Range-based Sharding (범위 기반 샤딩)**

<img src="https://github.com/user-attachments/assets/33dddb6c-6fa8-43dc-bc01-a6c96bebc635" width="500" alt="image">

데이터를 특정 값(Shard Key)의 특정 범위에 따라 분할하는 기법

- 예: 사용자 ID 1-1000은 샤드1, 1001-2000은 샤드2에 저장
- 장점: 구현이 간단하고, 범위 쿼리에 효율적.
- 단점: 데이터 쏠림 현상이 발생 가능. (예: 최근 데이터에 쿼리가 집중)

**2. Hash-based Sharding (해시 기반 샤딩)**

<img src="https://github.com/user-attachments/assets/72a22bd5-c7b3-4532-8f22-4212ab6b95a6" width="500" alt="image">

데이터를 특정 값(Shard Key)의 해시 함수에 따라 분할하는 기법

- 예: hash(user_id) % 4로 4개의 샤드에 분산.
- 장점: 데이터를 균등하게 분산 가능.
- 단점: 범위 쿼리의 효율성이 떨어지고, 샤드 추가/제거 시 재배치 필요.

**3. Directory-based Sharding (디렉토리 기반 샤딩)**

<img src="https://github.com/user-attachments/assets/0b33a621-f26a-471e-a688-6d8987af52c6" width="500" alt="image">

디렉토리를 이용하여 데이터가 저장된 샤드를 관리하는 기법

- 매핑 테이블을 이용하여 각 데이터가 저장된 샤드를 관리
- 장점: 유연한 데이터 분배가 가능하고, 동적으로 샤드를 추가/제거 가능.
- 단점: 디렉토리 관리 비용이 추가되고, 조회 시 추가적인 룩업이 필요.

### **물리적 샤드 vs 논리적 샤드**

**1.물리적 샤드**

- 실제 서로 다른 물리적 서버에 데이터를 분산 저장
- 단점: 데이터베이스의 확장(변경)으로 인해 Client의 수정도 수반될 수 있음

**논리적 샤드**

- 하나의 물리적 서버 내에서 논리적으로 데이터를 분할
- 장점: Router가 샤드 정보를 관리하여 Client 수정 없이 데이터베이스 확장 가능.

### 샤드와 파티셔닝 차이

어떻게 보면 샤딩은 수평 파티셔닝의 일종으로, 파티셔닝은 모든 데이터를 동일한 컴퓨터에 저장하지만, 샤딩은 데이터를 서로 다른 컴퓨터에 분산한다는 차이점이 있다.

물리적으로 서로 다른 컴퓨터에 데이터를 저장하므로, 쿼리 성능 향상과 더불어 부하가 분산되는 효과까지 얻을 수 있다. 즉, 샤딩은 데이터베이스 차원의 수평 확장(scale-out)인 셈이다.

## 3. 결론

데이터베이스의 수평적 확장인 샤딩을 구현할 때는 데이터의 특성, 쿼리 패턴, 확장성 요구사항 등을 고려하여 적절한 방식을 선택해야 하며, 샤딩으로 인한 복잡성 증가와 관리 오버헤드도 함께 고려해야 한다.

## References

- [데이터베이스 파티셔닝과 샤딩](https://hudi.blog/db-partitioning-and-sharding/)
- [Directory-Based Sharding | Implementation in Java](https://medium.com/@ganesh.shah/directory-based-sharding-implementation-in-java-2a3a8627e0ce)
- [데이터베이스 파티셔닝과 샤딩](https://hudi.blog/db-partitioning-and-sharding/)
